<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharaoh Online</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .screen {
            display: none;
            flex: 1;
            padding: 10px;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 2px;
            max-width: 400px;
            margin: 0 auto;
        }
        .cell {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #ddd;
        }
        .cell.wall {
            background-color: #666;
        }
        .cell.dug {
            background-color: #fff;
        }
        .cell.sand {
            background-color: #ffeb3b;
        }
        .cell.ghost-green {
            background-color: #4caf50;
        }
        .cell.ghost-red {
            background-color: #f44336;
        }
        .toolbar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
        .tool {
            padding: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: #fff;
        }
        .tool.active {
            background-color: #ddd;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .timer {
            font-size: 24px;
            text-align: center;
            margin-bottom: 10px;
        }
        .stats {
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .grid {
                max-width: 100%;
            }
            .cell {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <div id="main-screen" class="screen active">
        <h1>Pharaoh Online</h1>
        <button onclick="showScreen('editor')">Редактор карт</button>
        <button onclick="startRaid()">Начать рейд</button>
        <button onclick="showScreen('tombs')">Мои гробницы</button>
    </div>

    <div id="editor-screen" class="screen">
        <h2>Редактор карт</h2>
        <div class="toolbar">
            <div class="tool" data-type="snake" onclick="selectTool('snake')">Змея <span id="snake-count">0/4</span></div>
            <div class="tool" data-type="scarab" onclick="selectTool('scarab')">Скарабей <span id="scarab-count">0/2</span></div>
            <div class="tool" data-type="chest" onclick="selectTool('chest')">Сундук <span id="chest-count">0/1</span></div>
            <div class="tool" data-type="eraser" onclick="selectTool('eraser')">Ластик</div>
            <button onclick="rotateChest()">Повернуть</button>
        </div>
        <div id="editor-grid" class="grid"></div>
        <button id="publish-btn" onclick="publishMap()" disabled>Опубликовать</button>
        <button onclick="showScreen('main')">Назад</button>
    </div>

    <div id="gameplay-screen" class="screen">
        <div class="timer" id="timer">120</div>
        <div id="game-grid" class="grid"></div>
        <button onclick="leaveRaid()">Выйти</button>
    </div>

    <div id="tombs-screen" class="screen">
        <h2>Мои гробницы</h2>
        <div id="tombs-list"></div>
        <button onclick="showScreen('main')">Назад</button>
    </div>

    <div id="win-modal" class="modal">
        <div class="modal-content">
            <h3>Победа!</h3>
            <button onclick="claimReward()">Забрать деньги</button>
            <button onclick="nextStage()">Следующий этап</button>
        </div>
    </div>

    <div id="error-modal" class="modal">
        <div class="modal-content">
            <p id="error-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        let tg = null;
        var initData = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            initData = tg.initData;
        }
        let currentScreen = 'main';
        let editorGrid = [];
        let gameGrid = [];
        let sessionId = null;
        let timerInterval = null;
        let selectedTool = null;
        let chestOrientation = 'horizontal'; // horizontal or vertical

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + '-screen').classList.add('active');
            currentScreen = screen;
            if (screen === 'editor') {
                loadEditorTemplate();
            } else if (screen === 'tombs') {
                loadTombs();
            }
        }

        async function apiCall(endpoint, data = {}) {
            data.initData = initData;
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'API error');
                return result;
            } catch (e) {
                showError(e.message);
                throw e;
            }
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        // Editor functions
        async function loadEditorTemplate() {
            const data = await apiCall('/api/editor/template');
            editorGrid = data.grid;
            renderEditorGrid();
            updateCounts();
        }

        function renderEditorGrid() {
            const gridEl = document.getElementById('editor-grid');
            gridEl.innerHTML = '';
            editorGrid.forEach((cell, i) => {
                const cellEl = document.createElement('div');
                cellEl.className = 'cell';
                if (cell === 0) cellEl.classList.add('wall');
                cellEl.dataset.index = i;
                cellEl.addEventListener('click', () => placeItem(i));
                cellEl.addEventListener('mouseenter', () => showGhost(i));
                cellEl.addEventListener('mouseleave', () => hideGhost());
                gridEl.appendChild(cellEl);
            });
        }

        function selectTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
            if (tool) document.querySelector(`[data-type="${tool}"]`).classList.add('active');
        }

        function placeItem(index) {
            if (!selectedTool || selectedTool === 'eraser') {
                if (editorGrid[index] > 0) {
                    editorGrid[index] = 1; // empty
                    updateCounts();
                    renderEditorGrid();
                }
                return;
            }
            if (editorGrid[index] !== 1) return; // only on empty
            if (selectedTool === 'chest') {
                const secondIndex = getChestSecondIndex(index);
                if (secondIndex === null || editorGrid[secondIndex] !== 1) return;
                editorGrid[index] = 4;
                editorGrid[secondIndex] = 4;
            } else {
                const type = selectedTool === 'snake' ? 2 : 3;
                editorGrid[index] = type;
            }
            updateCounts();
            renderEditorGrid();
        }

        function getChestSecondIndex(index) {
            const row = Math.floor(index / 8);
            const col = index % 8;
            if (chestOrientation === 'horizontal' && col < 7) return index + 1;
            if (chestOrientation === 'vertical' && row < 5) return index + 8;
            return null;
        }

        function rotateChest() {
            chestOrientation = chestOrientation === 'horizontal' ? 'vertical' : 'horizontal';
        }

        function showGhost(index) {
            hideGhost();
            if (!selectedTool) return;
            const cells = [index];
            if (selectedTool === 'chest') {
                const second = getChestSecondIndex(index);
                if (second !== null) cells.push(second);
            }
            cells.forEach(i => {
                const cellEl = document.querySelector(`[data-index="${i}"]`);
                if (editorGrid[i] === 1) {
                    cellEl.classList.add('ghost-green');
                } else {
                    cellEl.classList.add('ghost-red');
                }
            });
        }

        function hideGhost() {
            document.querySelectorAll('.cell').forEach(c => {
                c.classList.remove('ghost-green', 'ghost-red');
            });
        }

        function updateCounts() {
            const snakes = editorGrid.filter(c => c === 2).length;
            const scarabs = editorGrid.filter(c => c === 3).length;
            const chests = Math.floor(editorGrid.filter(c => c === 4).length / 2);
            document.getElementById('snake-count').textContent = `${snakes}/4`;
            document.getElementById('scarab-count').textContent = `${scarabs}/2`;
            document.getElementById('chest-count').textContent = `${chests}/1`;
            document.getElementById('publish-btn').disabled = !(snakes === 4 && scarabs === 2 && chests === 1);
        }

        async function publishMap() {
            await apiCall('/api/maps/create', { grid: editorGrid });
            showScreen('main');
        }

        // Gameplay functions
        async function startRaid() {
            const scout = await apiCall('/api/raid/scout');
            const start = await apiCall('/api/raid/start', { map_id: scout.map_id });
            sessionId = start.session_id;
            gameGrid = start.grid;
            showScreen('gameplay');
            startTimer();
            renderGameGrid();
        }

        function renderGameGrid() {
            const gridEl = document.getElementById('game-grid');
            gridEl.innerHTML = '';
            gameGrid.forEach((cell, i) => {
                const cellEl = document.createElement('div');
                cellEl.className = 'cell';
                if (cell === 0) cellEl.classList.add('wall');
                else if (cell === 2) cellEl.classList.add('dug'); // assume dug if not wall
                else cellEl.classList.add('sand');
                if (cell !== 0 && cell !== 2) {
                    cellEl.addEventListener('click', () => dig(i));
                }
                gridEl.appendChild(cellEl);
            });
        }

        async function dig(index) {
            // loading
            const cellEl = document.querySelector(`#game-grid .cell:nth-child(${index + 1})`);
            cellEl.innerHTML = '<div>⏳</div>';
            try {
                const result = await apiCall('/api/raid/dig', { session_id: sessionId, cell_index: index });
                if (result.status === 'dead') {
                    showError('Вы погибли!');
                    showScreen('main');
                } else if (result.status === 'hurt') {
                    showError('Ранен скарабеем!');
                    showScreen('main');
                } else if (result.status === 'safe') {
                    gameGrid[index] = 2; // dug
                    renderGameGrid();
                    if (result.stage_complete) {
                        document.getElementById('win-modal').classList.add('active');
                    }
                }
            } catch (e) {
                cellEl.innerHTML = '';
            }
        }

        function startTimer() {
            let time = 120;
            timerInterval = setInterval(() => {
                time--;
                document.getElementById('timer').textContent = time;
                if (time <= 0) {
                    clearInterval(timerInterval);
                    leaveRaid();
                }
            }, 1000);
        }

        async function leaveRaid() {
            if (timerInterval) clearInterval(timerInterval);
            await apiCall('/api/raid/leave', { session_id: sessionId });
            showScreen('main');
        }

        async function claimReward() {
            await apiCall('/api/raid/leave', { session_id: sessionId });
            closeModal();
            showScreen('main');
        }

        async function nextStage() {
            // assume next stage logic, but since not specified, just restart
            closeModal();
            startRaid();
        }

        // Tombs functions
        async function loadTombs() {
            const data = await apiCall('/api/my_tombs');
            const listEl = document.getElementById('tombs-list');
            listEl.innerHTML = '';
            data.tombs.forEach(tomb => {
                const div = document.createElement('div');
                div.innerHTML = `<p>Карта ${tomb.id}: Убито ${tomb.deaths}, Заработано ${tomb.earnings}</p>
                <button onclick="claimTombReward(${tomb.id})" ${tomb.can_claim ? '' : 'disabled'}>Забрать награду</button>`;
                listEl.appendChild(div);
            });
        }

        async function claimTombReward(id) {
            await apiCall('/api/my_tombs/claim', { map_id: id });
            loadTombs();
        }

        // Init
        if (tg) tg.ready();
        apiCall('/api/login'); // login on start
    </script>
</body>
</html>