03. Логика Бэкенда и API

Middleware: Auth Check

Каждый запрос (кроме /health) должен содержать заголовок или поле initData.

Сервер проверяет HMAC-подпись с помощью BOT_TOKEN.

Сервер извлекает user_id.

Если валидация не прошла — 401 Unauthorized.

Основные Эндпоинты

1. POST /api/login

Действие: Проверяет юзера в БД. Если нет — создает.

Возврат: Объект User (баланс, кредиты) + проверяет, есть ли у юзера active сессия в RaidSessions. Если есть — возвращает данные для реконнекта.

2. POST /api/editor/template

Действие: Генерирует массив из 48 элементов, где рандомно расставлены стены (стены генерируются только на сервере).

Возврат: JSON с сеткой (стены и пустота).

3. POST /api/maps/create

Вход: grid (массив, расставленный игроком).

Валидация:

Кол-во стен совпадает с шаблоном?

Змей ровно 4?

Скарабеев ровно 2?

Сундук занимает 2 клетки и они соседние?

Есть ли у юзера builder_credits?

Действие: Списывает кредит, сохраняет карту в Maps.

4. POST /api/raid/scout (Разведка)

Действие: Проверяет, что баланс игрока позволяет поучаствовать. Ищет случайную карту (active=1, creator != me).

Возврат: ID карты (grid_json все равно секретен на сервере, скрытие ID — излишняя паранойя для MVP), статистика (смерти/победы), цена входа. НЕ возвращает grid_json.

5. POST /api/raid/start

Действие:

Fee в рейдах списывается до начала, во время нажатия на кнопку рейда. абуз невозможен

Проверяет баланс. Списывает Fee.

Создает запись в RaidSessions.

Устанавливает таймер (expires_at).

Возврат: session_id, массив стен (только стены!), открытые клетки (если кто-то уже копал).

6. POST /api/raid/dig (Самое важное)

Вход: session_id, cell_index.

Логика:

Проверить таймер. Если истек — вернуть status: timeout.

Загрузить карту из БД.

Если клетка уже открыта — ошибка.

Проверить, что в клетке:

Змея: Статус dead. Сессия закрывается. Буфер денег сгорает. Карта обновляется (добавляется череп в dug_json).

Скарабей: Статус hurt. Игрок вылетает, деньги сгорают, но клетка визуально не открывается для других (остается скрытой угрозой).

Сундук/Пусто: Статус safe. Деньги добавляются в earnings_buffer. Клетка добавляется в dug_json карты.

Победа: Если открыто 12+ клеток — вернуть stage_complete: true.

7. POST /api/raid/leave

Действие: Игрок забирает деньги.

Логика: Перевести earnings_buffer на balance юзера. Закрыть сессию.

8. GET /api/my_tombs

Действие: Возвращает список гробниц пользователя.

9. POST /api/my_tombs/claim

Действие: Клеймит награду из гробницы.

Правило: Если кол-во оставшихся безопасных клеток < Цель этапа, карта деактивируется (архивируется).

При рендеринге сетки, если клетка есть в dug_json и это ловушка — рисовать череп.